#!/usr/bin/env bash

# NOTE: This script has been adapted from content generated by github.com/conda-forge/conda-smithy

env

if [ "${UPLOAD_CHANNEL}" ];then
    export UPLOAD_CHANNEL=lightsource2
fi

REPO_ROOT=$(cd "$(dirname "$0")/.."; pwd;)
IMAGE_NAME="nsls2/debian-with-miniconda:latest"
config=$(cat <<CONDARC

channels:
 - $UPLOAD_CHANNEL
 - conda-forge
 - defaults

always_yes: true
show_channel_urls: True
track_features:
 - nomkl

CONDARC
)

docker pull $IMAGE_NAME

cat << EOF | docker run -i \
                        -v ${REPO_ROOT}:/repo \
                        -a stdin -a stdout -a stderr \
                        $IMAGE_NAME \
                        bash || exit $?

set -e
if [ "${BINSTAR_TOKEN}" ];then
    export BINSTAR_TOKEN=${BINSTAR_TOKEN}
fi

# Unused, but needed by conda-build currently... :(
export CONDA_NPY='110'

export PYTHONUNBUFFERED=1
echo "$config" > ~/.condarc

conda update conda
conda install conda-build anaconda-client networkx
# conda install conda-build conda-build-all conda-execute
pip install https://github.com/ericdill/conda-build-utils/zipball/master#egg=conda-build-utils
conda info

# dont allow failures on the conda-build commands
set -e

# pushd /repo
# build_from_yaml build-directive.yaml -u $UPLOAD_CHANNEL --no-upload $NO_UPLOAD
# popd
devbuild /repo/config -u $UPLOAD_CHANNEL --python 2.7 3.4 3.5 --numpy 1.10 1.11 -t $BINSTAR_TOKEN
devbuild /repo/recipes -u $UPLOAD_CHANNEL --python 2.7 3.4 3.5 --numpy 1.10 1.11 -t $BINSTAR_TOKEN
# These are some standard tools. But they aren't available to a recipe at this point (we need to figure out how a recipe should define OS level deps)
#yum install -y expat-devel git autoconf libtool texinfo check-devel
#
# echo "
#
# ===== BUILDING SCIKIT-BEAM RECIPES =====
#
# "
# conda-build-all /tmp/skbeam-recipes/recipes --upload-channels $UPLOAD_CHANNEL --matrix-conditions "numpy >=1.10,<1.11" "python >=2.7,<3|>=3.4" --inspect-channels $UPLOAD_CHANNEL
#
# echo "
#
# ===== BUILDING NONPY =====
#
# "
# conda-build-all /nonpy-recipes --upload-channels $UPLOAD_CHANNEL --inspect-channels $UPLOAD_CHANNEL --matrix-conditions "python >=3.5"
#
# echo "
#
# ===== BUILDING PY2 =====
#
# "
# conda-build-all /py2-recipes --upload-channels $UPLOAD_CHANNEL --matrix-conditions "numpy >=1.10,<1.11" "python >=2.7,<3" --inspect-channels $UPLOAD_CHANNEL
#
# echo "
#
# ===== BUILDING PY2&PY3 =====
#
# "
# conda-build-all /pyall-recipes --upload-channels $UPLOAD_CHANNEL --matrix-conditions "numpy >=1.10,<1.11" "python >=2.7,<3|>=3.4" --inspect-channels $UPLOAD_CHANNEL
#
# echo "
#
# ===== BUILDING PY3 =====
#
# "
# conda-build-all /py3-recipes --upload-channels $UPLOAD_CHANNEL --matrix-conditions "numpy >=1.10,<1.11" "python >=3.4" --inspect-channels $UPLOAD_CHANNEL
#
# echo "
#
# ===== BUILDING PY3 =====
#
# "
# conda-build-all /py3-recipes --upload-channels $UPLOAD_CHANNEL --matrix-conditions "numpy >=1.10,<1.11" "python >=3.4" --inspect-channels $UPLOAD_CHANNEL
#
# echo "========== Running sort-of-dev-but-actually-tag builds =========="
# devbuild /py3-dev --username $UPLOAD_CHANNEL --pyver 3.4 3.5
#
EOF
