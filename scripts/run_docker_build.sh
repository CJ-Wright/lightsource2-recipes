#!/usr/bin/env bash

# NOTE: This script has been adapted from content generated by github.com/conda-forge/conda-smithy
CLONE_DIR=/tmp/$LOGNAME/staged-recipes-dev
# UPLOAD_CHANNEL=lightsource2-dev

REPO_ROOT=$(cd "$(dirname "$0")/.."; pwd;)
IMAGE_NAME="nsls2/debian-with-miniconda:latest"
ANACONDA_SERVER_URL=${ANACONDA_SERVER_URL:-"https://api.anaconda.org"}
if [ $ANACONDA_SERVER_URL == "https://api.anaconda.org" ]; then
  TAG_CHANNEL='lightsource2'
  CONDA_FORGE="conda-forge"
else
  TAG_CHANNEL='nsls2-tag'
fi;

cat << EOF | docker run -i \
                        -v ${REPO_ROOT}:/repo \
                        -a stdin -a stdout -a stderr \
                        $IMAGE_NAME \
                        bash || exit $?

if [ "${BINSTAR_TOKEN}" ];then
    export BINSTAR_TOKEN=${BINSTAR_TOKEN}
fi

mkdir -p ~/.config/binstar
echo "Setting anaconda server url to $ANACONDA_SERVER_URL"
echo "url: $ANACONDA_SERVER_URL" > ~/.config/binstar/config.yaml


echo "binstar_upload: false
always_yes: true
show_channel_urls: true
channels:" > ~/.condarc

if [ $ANACONDA_SERVER_URL == "https://api.anaconda.org" ]; then
  echo "- $UPLOAD_CHANNEL
- lightsource2
- conda-forge
- defaults" >> ~/.condarc
else
  echo "- $UPLOAD_CHANNEL
- nsls2-tag
- defaults" >> ~/.condarc
fi;

echo "contents of ~/.condarc"
cat ~/.condarc

conda install conda-build anaconda-client --yes

echo UPLOAD_CHANNEL=$UPLOAD_CHANNEL
echo CLONE_DIR=$CLONE_DIR

# Unused, but needed by conda-build currently... :(
export CONDA_NPY='110'

export PYTHONUNBUFFERED=1

pip install https://github.com/nsls-ii/conda-build-utils/zipball/master#egg=conda-build-utils

devbuild /repo/recipes -u $UPLOAD_CHANNEL --python 2.7 3.4 3.5 --numpy 1.10 1.11
EOF
