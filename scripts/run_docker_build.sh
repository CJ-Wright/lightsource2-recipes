#!/usr/bin/env bash

# NOTE: This script has been adapted from content generated by github.com/conda-forge/conda-smithy

REPO_ROOT=$(cd "$(dirname "$0")/.."; pwd;)
IMAGE_NAME="ericdill/nsls2debian79"

config=$(cat <<CONDARC

channels:
 - lightsource2
 - conda-forge
 - defaults

always_yes: true
show_channel_urls: True

CONDARC
)

cat << EOF | docker run -i \
                        -v ${REPO_ROOT}/nonpy:/nonpy-recipes \
                        -v ${REPO_ROOT}/py2:/py2-recipes \
                        -v ${REPO_ROOT}/py3:/py3-recipes \
                        -v ${REPO_ROOT}/py35:/py35-recipes \
                        -v ${REPO_ROOT}/pyall:/pyall-recipes \
                        -a stdin -a stdout -a stderr \
                        $IMAGE_NAME \
                        bash || exit $?

if [ "${BINSTAR_TOKEN}" ];then
    export BINSTAR_TOKEN=${BINSTAR_TOKEN}
fi

# Unused, but needed by conda-build currently... :(
export CONDA_NPY='19'

export PYTHONUNBUFFERED=1
echo "$config" > ~/.condarc

# A lock sometimes occurs with incomplete builds. The lock file is stored in build_artefacts.
conda clean --lock

conda update conda
# install to get the dependencies
conda install conda-build anaconda-client conda-build-all
# remove so we can install master
conda remove conda-build conda-build-all
pip install https://github.com/conda/conda-build/zipball/master#egg=conda-build
conda remove conda-build-all
pip install https://github.com/SciTools/conda-build-all/zipball/master#egg=conda-build-all
conda info
unset LANG

# These are some standard tools. But they aren't available to a recipe at this point (we need to figure out how a recipe should define OS level deps)
#yum install -y expat-devel git autoconf libtool texinfo check-devel

# These were specific to installing matplotlib. I really want to avoid doing this if possible, but in some cases it
# is inevitable (without re-implementing a full OS), so I also really want to ensure we can annotate our recipes to
# state the build dependencies at OS level, too.
yum install -y libXext libXrender libSM tk libX11-devel

# install zlib-devel for git recipe
yum install -y zlib-devel perl-devel perl-CPAN curl-devel expat-devel gettext-devel openssl-devel asciidoc xmlto docbook2X
# more git configuration
sudo ln -s /usr/bin/db2x_docbook2texi /usr/bin/docbook2x-texi

conda-build-all /nonpy-recipes --upload-channels lightsource2 --inspect-channels lightsource2 --matrix-conditions "numpy >=1.10" "python >=3.5"
conda-build-all /py2-recipes --upload-channels lightsource2 --matrix-conditions "numpy >=1.10" "python >=2.7,<3" --inspect-channels lightsource2
conda-build-all /py3-recipes --upload-channels lightsource2 --matrix-conditions "numpy >=1.10" "python >=3.4" --inspect-channels lightsource2
conda-build-all /py35-recipes --upload-channels lightsource2 --matrix-conditions "numpy >=1.10" "python >=3.5" --inspect-channels lightsource2
conda-build-all /pyall-recipes --upload-channels lightsource2 --matrix-conditions "numpy >=1.10" "python >=2.7,<3|>=3.4" --inspect-channels lightsource2

EOF

